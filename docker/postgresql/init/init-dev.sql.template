-- ========== 開発用データベースの作成 ==========

-- syllabus_dbが作成されるまで待機
DO $$
BEGIN
    WHILE NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = '${POSTGRES_DB}') LOOP
        PERFORM pg_sleep(1);
    END LOOP;
END
$$;

-- 既存の開発用データベースを削除
DROP DATABASE IF EXISTS ${DEV_DB};

-- 開発用データベースの作成
CREATE DATABASE ${DEV_DB} WITH TEMPLATE ${POSTGRES_DB};

-- ========== 権限付与 ==========

-- 開発用データベースへの権限付与
GRANT ALL PRIVILEGES ON DATABASE ${DEV_DB} TO dev_user;
GRANT ALL PRIVILEGES ON DATABASE ${DEV_DB} TO app_user;

-- 開発用データベースのスキーマ権限付与
\c ${DEV_DB}
GRANT ALL ON SCHEMA public TO dev_user;
GRANT ALL ON SCHEMA public TO app_user;

-- 開発用データベースのテーブル・シーケンス権限付与
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO dev_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO app_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO dev_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO app_user;

-- 開発用データベースのデフォルト権限設定
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO dev_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO app_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO dev_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO app_user;

-- 開発用データベースのカタログ参照権限付与
GRANT USAGE ON SCHEMA public TO dev_user;
GRANT USAGE ON SCHEMA public TO app_user;
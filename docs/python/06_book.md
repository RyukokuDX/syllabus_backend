---
title: 06_book.pyの仕様書
file_version: v1.3.4
project_version: v1.3.4
last_updated: 2025-06-19
---

# `06_book.py`の仕様書　

- File Version: v1.3.4
- Project Version: v1.3.4
- Last Updated: 2025-06-19

[readmeへ](../README.md) | [ドキュメント作成ガイドラインへ](./doc.md)

## 目次
1. [概要](#概要)
2. [解析対象](#解析対象)
3. [出力形式](#出力形式)
4. [警告ファイル](#警告ファイル)
5. [処理フロー](#処理フロー)
6. [類似度計算](#類似度計算)

## 概要
`06_book.py`は、シラバスから書籍情報を抽出し、データベース用のJSONファイルを生成するスクリプトです。

## 解析対象
### 対象ディレクトリ
- `src/syllabus/{year}/json/`
  - `{year}`は後述の方法で取得

### 対象フィールド
以下の2つのリスト内の指定フィールドを解析対象とします：
1. `"詳細情報"."テキスト"."内容"."書籍"`のリスト
2. `"詳細情報"."参考文献"."内容"."書籍"`のリスト

これらのリスト内のレコードを「対象レコード」と呼びます。

## 出力形式
### 基本形式
- `docs/database/structure.md`のbookテーブルのカラムに対応したJSON形式
- 出力は単一ファイルにまとめる
- 出力ファイルは「出力JSON」と呼ぶ

## 警告ファイル
### 基本情報
- パス: `warning/{year}/book_yyyymmdd_hhmm.csv`
- エンコーディング: UTF-8

### CSVヘッダー
```
"{projectルートからのシラバスjsonのpath}", "error message", "time"
```

## 処理フロー
### 年度取得
1. 起動時の引数で`{year}`を取得
2. 引数が空の場合：
   - ユーザーに入力を再要請
   - 再要請時も空の場合：今年の年数を`{year}`とする

### 書籍情報処理
tqdmで進捗を表示しながら、シラバスJSONを以下のように処理：

#### ISBNがnullの場合
- シラバスJSONのデータから出力JSONに追記

#### ISBNが存在する場合
- 桁数確認
  - 異常あり：
    - 警告ファイルに記載（error message: "不正ISBN: 桁数違反"）
    - シラバスJSONの対象レコードから出力JSONに追記
  - 異常なし：
    - チェックディジット（cd）確認
      - 異常あり：
        - 警告ファイルに記載（error message: "不正ISBN: cd違反"）
        - シラバスJSONの対象レコードから出力JSONに追記
      - 異常なし：
        - `src/books/{ISBN}.json`の存在確認
          - 存在しない：
            - CiNii APIで検索
              - ヒットなし：
                - 警告ファイルに記載（error message: "問題ISBN: ciniiデータ不在"）
              - ヒットあり：
                - `src/books/{ISBN}.json`に保存
                - 存在する場合の処理に進む
          - 存在する：
            - 書籍名の類似度比較
              - 類似度0.2以下：
                - 警告ファイルに記載（error message: "問題レコード: 書籍名類似度低"）
              - 類似度0.2以上：
                - priceフィールド：該当レコードから取得
                - その他：`src/books/{ISBN}.json`から取得
                - 出力JSONに追記

## 類似度計算
### 概要
書籍名の類似度は、文字列の類似度と単語の類似度を組み合わせて計算します。

### 計算方法
1. 前処理
   - 大文字小文字の違いを無視
   - 記号の違いを無視
   - 余分な空白を正規化

2. 類似度の計算
   - 文字列の類似度（重み: 0.7）
     - レーベンシュタイン距離を使用
     - 距離が小さいほど類似度が高い
   - 単語の類似度（重み: 0.3）
     - 共通する単語の割合を計算
     - シリーズ名の違いによる影響を軽減

3. 閾値
   - 0.2未満：明らかに異なる書籍
   - 0.2以上0.5未満：要確認の範囲
   - 0.5以上：同じ書籍の可能性が高い

[🔝 ページトップへ](#06_bookpyの仕様書)
---
title: 06_book.pyの仕様書
file_version: v1.3.7
project_version: v1.3.12
last_updated: 2025-06-20
---

# `06_book.py`の仕様書　

- File Version: v1.3.7
- Project Version: v1.3.12
- Last Updated: 2025-06-20

[readmeへ](../README.md) | [ドキュメント作成ガイドラインへ](./doc.md)

## 目次
1. [概要](#概要)
2. [解析対象](#解析対象)
3. [出力形式](#出力形式)
4. [警告ファイル](#警告ファイル)
5. [処理フロー](#処理フロー)
6. [類似度計算](#類似度計算)
7. [BibTeX処理](#bibtex処理)
8. [警告メッセージ](#警告メッセージ)

## 概要
`06_book.py`は、シラバスから書籍情報を抽出し、データベース用のJSONファイルを生成するスクリプトです。CiNii APIとBibTeXデータを活用して書籍情報の精度を向上させます。

## 解析対象
### 対象ディレクトリ
- `src/syllabus/{year}/json/`
  - `{year}`は後述の方法で取得

### 対象フィールド
以下の2つのリスト内の指定フィールドを解析対象とします：
1. `"詳細情報"."テキスト"."内容"."書籍"`のリスト
2. `"詳細情報"."参考文献"."内容"."書籍"`のリスト

これらのリスト内のレコードを「対象レコード」と呼びます。

## 出力形式
### 基本形式
- `docs/database/structure.md`のbookテーブルのカラムに対応したJSON形式
- 出力は単一ファイルにまとめる
- 出力ファイルは「出力JSON」と呼ぶ

### 出力構造
```json
{
  "books": [
    {
      "title": "書籍タイトル",
      "author": "著者名（カンマ区切り）",
      "publisher": "出版社名",
      "price": 価格,
      "isbn": "ISBN番号",
      "created_at": "作成日時"
    }
  ]
}
```

## 警告ファイル
### 基本情報
- パス: `warning/{year}/book_yyyymmdd_hhmm.csv`
- エンコーディング: UTF-8

### CSVヘッダー
```
"{projectルートからのシラバスjsonのpath}", "ISBN", "error message", "time"
```

### 重複警告防止
- 同じISBNとメッセージの組み合わせは1回だけ記録
- 警告の重複記録を防ぐ機能を実装

## 処理フロー
### 年度取得
1. 起動時の引数で`{year}`を取得
2. 引数が空の場合：
   - ユーザーに入力を再要請
   - 再要請時も空の場合：今年の年数を`{year}`とする

### 書籍情報処理
tqdmで進捗を表示しながら、シラバスJSONを以下のように処理：

#### ISBNがnullの場合
- シラバスJSONのデータから出力JSONに追記

#### ISBNが存在する場合
- 桁数確認（数字以外の文字を除去した後の長さで判定）
  - 異常あり：
    - 警告ファイルに記載（error message: "不正ISBN: 桁数違反"）
    - シラバスJSONの対象レコードから出力JSONに追記
  - 異常なし：
    - チェックディジット（cd）確認
      - 異常あり：
        - 警告ファイルに記載（error message: "不正ISBN: cd違反"）
        - シラバスJSONの対象レコードから出力JSONに追記
      - 異常なし：
        - `src/books/json/{ISBN}.json`の存在確認
          - 存在しない：
            - CiNii APIで検索
              - ヒットなし：
                - 警告ファイルに記載（error message: "問題ISBN: ciniiデータ不在"）
              - ヒットあり：
                - `src/books/json/{ISBN}.json`に保存
                - 存在する場合の処理に進む
          - 存在する：
            - BibTeX経由で書籍情報を取得
              - 取得成功：
                - 書籍名の類似度比較
                  - 類似度0.05以下：
                    - 警告ファイルに記載（error message: "問題レコード: 書籍名類似度低"）
                  - 類似度0.05以上：
                    - priceフィールド：該当レコードから取得
                    - その他：BibTeXから取得
                    - 出力JSONに追記
              - 取得失敗：
                - 既存のCiNiiデータを使用
                - 書籍名の類似度比較（閾値0.05）
                - 類似度が低い場合は警告記録

### 著者情報の処理
- 書籍情報の`author`フィールドはカンマ区切りの文字列として保存
- 著者名の正規化（前後の空白除去、重複除去）を実施

## 類似度計算
### 概要
書籍名の類似度は、文字列の類似度と単語の類似度を組み合わせて計算します。

### 計算方法
1. 前処理
   - 大文字小文字の違いを無視
   - 記号の違いを無視
   - 余分な空白を正規化

2. 類似度の計算
   - 文字列の類似度（重み: 0.7）
     - レーベンシュタイン距離を使用
     - 距離が小さいほど類似度が高い
   - 単語の類似度（重み: 0.3）
     - 共通する単語の割合を計算
     - シリーズ名の違いによる影響を軽減

3. 閾値
   - 0.05未満：明らかに異なる書籍（警告記録）
   - 0.05以上：同じ書籍の可能性が高い

## BibTeX処理
### 処理フロー
1. 既存JSONファイルからBN（CiNii ID）を抽出
2. `src/books/bib/{BN}.bib`の存在確認
3. 存在しない場合：
   - CiNiiからBibTeXファイルを取得
   - `src/books/bib/{BN}.bib`に保存
4. BibTeXファイルをパースして書籍情報を抽出

### BibTeXパーサー
- 正しいBibTeX形式に対応
- author、title、publisherフィールドを抽出
- ダブルクォートとカンマの適切な処理

### データ保存先
- JSONファイル: `src/books/json/{ISBN}.json`
- BibTeXファイル: `src/books/bib/{BN}.bib`

## 警告メッセージ
### 警告の種類
1. **不正ISBN: 桁数違反**
   - ISBNの桁数が10または13でない場合

2. **不正ISBN: cd違反**
   - ISBNのチェックディジットが正しくない場合

3. **問題ISBN: ciniiデータ不在**
   - CiNii APIで書籍情報が見つからない場合

4. **問題レコード: 書籍名類似度低**
   - シラバスとCiNii/BibTeXの書籍名の類似度が0.05未満の場合

5. **不正BibTeX データ: Null検知**
   - BibTeXデータでタイトル、著者、出版社が空の場合

6. **不正CiNii データ: Null検知**
   - CiNiiデータでタイトル、著者、出版社が空の場合

### デバッグ情報
- tqdm.writeを使用して詳細なデバッグ情報を出力
- 処理中の書籍情報、類似度計算結果、データ取得状況を記録

[🔝 ページトップへ](#06_bookpyの仕様書)
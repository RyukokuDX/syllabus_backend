---
title: JSONBã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆä»•æ§˜æ›¸
file_version: v2.0.2
project_version: v2.0.4
last_updated: 2025-07-01
---

# JSONBã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆä»•æ§˜æ›¸

- File Version: v2.0.2
- Project Version: v2.0.4
- Last Updated: 2025-07-01

[readmeã¸](../../README.md) | [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ å®šç¾©ã¸](structure.md) | [è¨­è¨ˆãƒãƒªã‚·ãƒ¼ã¸](policy.md) | [ERå›³ã¸](er.md)

## ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«](#ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«)
3. [ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”Ÿæˆæ–¹é‡](#ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”Ÿæˆæ–¹é‡)
4. [ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°æˆ¦ç•¥](#ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°æˆ¦ç•¥)
5. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …)
6. [å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](#å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³)

## ç›®çš„
- è¤‡é›‘ãªJOINã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹åŠ¹ç‡åŒ–
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã‚’é‡è¦–ã—ãªã„é›†è¨ˆãƒ»åˆ†æå‡¦ç†ã®é«˜é€ŸåŒ–

## ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”Ÿæˆæ–¹é‡

### åŸºæœ¬æ–¹é‡
1. **LLMã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹æ€§é‡è¦–** idã‚„ã‚³ãƒ¼ãƒ‰ã‚’åˆ©ç”¨ã—ãªã„, è‡ªç„¶è¨€èªã«ã‚ˆã‚‹è§£æ
1. **éšå±¤æ§‹é€ ã®æ´»ç”¨**: è¦ªå­é–¢ä¿‚ã‚’æ˜ç¢ºã«è¡¨ç¾
1. **é…åˆ—ã®æ´»ç”¨**: 1å¯¾å¤šã®é–¢ä¿‚ã‚’é…åˆ—ã¨ã—ã¦è¡¨ç¾

### æ›´æ–°æ–¹å¼
1. **å…¨é‡æ›´æ–°**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥å…¨ä½“ã‚’å†ç”Ÿæˆ

## JSONBãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

### ã‚µãƒ³ãƒ—ãƒ«æ§‹é€ 
```json
{
  "ç§‘ç›®å": "å¾®åˆ†ç©åˆ†å­¦I",
  "é–‹è¬›æƒ…å ±": [
    {
      "å¹´": 2025,
      "ã‚·ãƒ©ãƒã‚¹": [
        {
          "æ‹…å½“": [
            {
              "æ•™å“¡å": "ç”°ä¸­ å¤ªéƒ",
              "å½¹å‰²": "ä¸»æ‹…å½“"
            },
            {
              "æ•™å“¡å": "ä½è—¤ èŠ±å­",
              "å½¹å‰²": "å‰¯æ‹…å½“"
            }
          ],
          "å­¦æœŸ": "1Q",
          "æ›œæ—¥": "æœˆæ›œæ—¥",
          "æ™‚é™": [1,2],
          "å˜ä½": 2,
          "æ•™ç§‘æ›¸": [
            {
              "æ›¸å": "å¾®åˆ†ç©åˆ†å­¦å…¥é–€",
              "è‘—è€…": "å±±ç”° æ•°å­¦",
              "ISBN": "978-4-1234-5678-9",
              "å€¤æ®µ": 2500,
              "å‚™è€ƒ": "ç¬¬3ç‰ˆã‚’ä½¿ç”¨"
            }
          ],
          "æ•™ç§‘æ›¸ã‚³ãƒ¡ãƒ³ãƒˆ": "è²·ã£ã¦ãã ã•ã„",
          "å‚è€ƒæ›¸": [
            {
              "æ›¸å": "å¤§å­¦æ•°å­¦ã®åŸºç¤",
              "è‘—è€…": "éˆ´æœ¨ è¨ˆç®—",
              "ISBN": "978-4-9876-5432-1",
              "å€¤æ®µ": 1800,
              "å‚™è€ƒ": "å‚è€ƒç¨‹åº¦"
            }
          ],
          "å‚è€ƒæ›¸ã‚³ãƒ¡ãƒ³ãƒˆ": "å€Ÿã‚Šã¦ä¸‹ã•ã„",
          "æˆç¸¾": [
            {
              "é …ç›®": "å®šæœŸè©¦é¨“",
              "å‰²åˆ": 70,
              "è©•ä¾¡æ–¹æ³•": "ç­†è¨˜è©¦é¨“",
              "å‚™è€ƒ": "ä¸­é–“è©¦é¨“30%ã€æœŸæœ«è©¦é¨“40%"
            },
            {
              "é …ç›®": "å¹³å¸¸ç‚¹",
              "å‰²åˆ": 30,
              "è©•ä¾¡æ–¹æ³•": "å‡ºå¸­ãƒ»èª²é¡Œæå‡º",
              "å‚™è€ƒ": "æ¯å›ã®èª²é¡Œæå‡ºã‚’è©•ä¾¡"
            }
          ],
          "æˆç¸¾ã‚³ãƒ¡ãƒ³ãƒˆ": "æ…ˆæ‚²ã¯ãªã„"
        }
      ]
    }
  ],
  "å±¥ä¿®æƒ…å ±": [
    {
      "å¹´": 2025,
      "å±¥ä¿®è¦ç¶±": [
        {
          "å­¦éƒ¨èª²ç¨‹": "ç†å·¥å­¦éƒ¨",
          "ç§‘ç›®åŒºåˆ†": "å°‚é–€åŸºç¤ç§‘ç›®",
          "ç§‘ç›®å°åŒºåˆ†": "æ•°å­¦",
          "å¿…é ˆåº¦": "å¿…ä¿®",
          "å­¦ä¿®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ": [1,2,3]
        },
        {
          "å­¦éƒ¨èª²ç¨‹": "å…ˆç«¯ç†å·¥å­¦éƒ¨",
          "ç§‘ç›®åŒºåˆ†": "å°‚é–€åŸºç¤ç§‘ç›®",
          "ç§‘ç›®å°åŒºåˆ†": "æ•°å­¦",
          "å¿…é ˆåº¦": "é¸æŠ",
          "èª²ç¨‹åˆ¥ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£": "æƒ…å ±å·¥å­¦ç§‘"
        }
      ]
    }
  ]
}
```

### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¬æ˜

#### åŸºæœ¬æƒ…å ±
- **ç§‘ç›®å**: ç§‘ç›®ã®æ­£å¼åç§°ï¼ˆsubject_name.nameï¼‰

#### é–‹è¬›æƒ…å ±
- **å¹´**: ã‚·ãƒ©ãƒã‚¹ã®å¹´åº¦ï¼ˆsyllabus_master.syllabus_yearï¼‰
- **ã‚·ãƒ©ãƒã‚¹**: å¹´åº¦å†…ã®ã‚·ãƒ©ãƒã‚¹æƒ…å ±ã®é…åˆ—

##### ã‚·ãƒ©ãƒã‚¹è©³ç´°
- **æ‹…å½“**: æ•™å“¡æƒ…å ±ã®é…åˆ—
  - **æ•™å“¡å**: æ•™å“¡ã®æ°åï¼ˆinstructor.nameï¼‰
  - **å½¹å‰²**: æ‹…å½“æ•™å“¡ã®å½¹å‰²ï¼ˆsyllabus_instructor.roleï¼‰
- **å­¦æœŸ**: é–‹è¬›å­¦æœŸï¼ˆsyllabus.termï¼‰
- **æ›œæ—¥**: é–‹è¬›æ›œæ—¥ï¼ˆlecture_time.day_of_weekï¼‰
- **æ™‚é™**: é–‹è¬›æ™‚é™ï¼ˆlecture_time.periodï¼‰
- **å˜ä½**: å˜ä½æ•°ï¼ˆsyllabus.creditsï¼‰
- **æ•™ç§‘æ›¸**: æ•™ç§‘æ›¸æƒ…å ±ã®é…åˆ—ï¼ˆsyllabus_book.role = "æ•™ç§‘æ›¸" or book_uncategorized.role = "æ•™ç§‘æ›¸"ï¼‰
- **å‚è€ƒæ›¸**: å‚è€ƒæ›¸æƒ…å ±ã®é…åˆ—ï¼ˆsyllabus_book.role = "å‚è€ƒæ›¸" or book_uncategorized.role = "å‚è€ƒæ›¸"ï¼‰
- **æˆç¸¾**: æˆç¸¾è©•ä¾¡åŸºæº–ã®é…åˆ—

##### æ›¸ç±æƒ…å ±
- **æ›¸å**: æ›¸ç±ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆbook.title or book_uncategorized.titleï¼‰
- **è‘—è€…**: è‘—è€…åï¼ˆbook.author or book_uncategorized.authorï¼‰
- **ISBN**: ISBNç•ªå·ï¼ˆbook.isbn or book_uncategorized.isbnï¼‰
- **å€¤æ®µ**: ä¾¡æ ¼ï¼ˆbook.price or book_uncategorized.priceï¼‰
- **å‚™è€ƒ**: å‚™è€ƒæƒ…å ±ï¼ˆsyllabus_book.noteã®ã¿ã€book_uncategorizedã«ã¯å‚™è€ƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—ï¼‰

##### æˆç¸¾è©•ä¾¡
- **é …ç›®**: è©•ä¾¡é …ç›®ï¼ˆgrading_criterion.criteria_typeï¼‰
- **å‰²åˆ**: è©•ä¾¡æ¯”ç‡ï¼ˆgrading_criterion.ratioï¼‰
- **è©•ä¾¡æ–¹æ³•**: è©•ä¾¡æ–¹æ³•ã®è©³ç´°ï¼ˆgrading_criterion.criteria_descriptionï¼‰
- **å‚™è€ƒ**: å‚™è€ƒæƒ…å ±ï¼ˆgrading_criterion.noteï¼‰

#### å±¥ä¿®æƒ…å ±
- **å¹´**: å±¥ä¿®è¦ç¶±ã®å¹´åº¦ï¼ˆsubject.curriculum_yearï¼‰
- **å±¥ä¿®è¦ç¶±**: å±¥ä¿®è¦ç¶±æƒ…å ±ã®é…åˆ—

##### å±¥ä¿®è¦ç¶±è©³ç´°
- **å­¦éƒ¨èª²ç¨‹**: é–‹è¬›å­¦éƒ¨ãƒ»èª²ç¨‹ï¼ˆfaculty.faculty_nameï¼‰
- **ç§‘ç›®åŒºåˆ†**: ç§‘ç›®åŒºåˆ†ï¼ˆclass.class_nameï¼‰
- **ç§‘ç›®å°åŒºåˆ†**: ç§‘ç›®å°åŒºåˆ†ï¼ˆsubclass.subclass_nameï¼‰
- **å¿…é ˆåº¦**: å¿…ä¿®/é¸æŠåŒºåˆ†ï¼ˆsubject.requirement_typeï¼‰
- **èª²ç¨‹åˆ¥ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£**: èª²ç¨‹åˆ¥ã®è©³ç´°æƒ…å ±ï¼ˆsubject_attribute_value.value where attribute_id = èª²ç¨‹åˆ¥ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰
    - å­¦ç¿’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã“ã®ã‚µãƒ³ãƒ—ãƒ«

### ç”ŸæˆQuerry

#### subject_syllabus_cache

```sql
WITH syllabus_data AS (
    SELECT 
        sm.syllabus_id,
        sm.syllabus_code,
        sm.syllabus_year,
        s.subject_name_id,
        sn.name as subject_name,
        s.subtitle,
        s.term,
        s.campus,
        s.credits,
        s.goals,
        s.summary,
        s.attainment,
        s.methods,
        s.outside_study,
        s.textbook_comment,
        s.reference_comment,
        s.grading_comment,
        s.advice
    FROM syllabus_master sm
    JOIN syllabus s ON sm.syllabus_id = s.syllabus_id
    JOIN subject_name sn ON s.subject_name_id = sn.subject_name_id
),
instructor_data AS (
    SELECT 
        si.syllabus_id,
        json_agg(
            json_build_object(
                'æ•™å“¡å', i.name,
                'å½¹å‰²', COALESCE(si.role, 'æ‹…å½“')
            )
        ) as instructors
    FROM syllabus_instructor si
    JOIN instructor i ON si.instructor_id = i.instructor_id
    GROUP BY si.syllabus_id
),
lecture_time_data AS (
    SELECT 
        lt.syllabus_id,
        json_agg(
            json_build_object(
                'æ›œæ—¥', lt.day_of_week,
                'æ™‚é™', lt.period
            )
        ) as lecture_times,
        json_agg(lt.period) as periods
    FROM lecture_time lt
    GROUP BY lt.syllabus_id
),
textbook_data AS (
    SELECT 
        syllabus_id,
        json_agg(book_info) as textbooks
    FROM (
        -- syllabus_bookã‹ã‚‰æ•™ç§‘æ›¸ã‚’å–å¾—
        SELECT 
            sb.syllabus_id,
            json_build_object(
                'æ›¸å', b.title,
                'è‘—è€…', b.author,
                'ISBN', b.isbn,
                'å€¤æ®µ', b.price,
                'å‚™è€ƒ', sb.note
            ) as book_info
        FROM syllabus_book sb
        JOIN book b ON sb.book_id = b.book_id
        WHERE sb.role = 'æ•™ç§‘æ›¸'
        
        UNION ALL
        
        -- book_uncategorizedã‹ã‚‰æ•™ç§‘æ›¸ã‚’å–å¾—
        SELECT 
            bu.syllabus_id,
            json_build_object(
                'æ›¸å', bu.title,
                'è‘—è€…', bu.author,
                'ISBN', bu.isbn,
                'å€¤æ®µ', bu.price
            ) as book_info
        FROM book_uncategorized bu
        WHERE bu.role = 'æ•™ç§‘æ›¸'
    ) combined_textbooks
    GROUP BY syllabus_id
),
reference_data AS (
    SELECT 
        syllabus_id,
        json_agg(book_info) as references
    FROM (
        -- syllabus_bookã‹ã‚‰å‚è€ƒæ›¸ã‚’å–å¾—
        SELECT 
            sb.syllabus_id,
            json_build_object(
                'æ›¸å', b.title,
                'è‘—è€…', b.author,
                'ISBN', b.isbn,
                'å€¤æ®µ', b.price,
                'å‚™è€ƒ', sb.note
            ) as book_info
        FROM syllabus_book sb
        JOIN book b ON sb.book_id = b.book_id
        WHERE sb.role = 'å‚è€ƒæ›¸'
        
        UNION ALL
        
        -- book_uncategorizedã‹ã‚‰å‚è€ƒæ›¸ã‚’å–å¾—
        SELECT 
            bu.syllabus_id,
            json_build_object(
                'æ›¸å', bu.title,
                'è‘—è€…', bu.author,
                'ISBN', bu.isbn,
                'å€¤æ®µ', bu.price
            ) as book_info
        FROM book_uncategorized bu
        WHERE bu.role = 'å‚è€ƒæ›¸'
    ) combined_references
    GROUP BY syllabus_id
),
grading_data AS (
    SELECT 
        gc.syllabus_id,
        json_agg(
            json_build_object(
                'é …ç›®', gc.criteria_type,
                'å‰²åˆ', gc.ratio,
                'è©•ä¾¡æ–¹æ³•', gc.criteria_description,
                'å‚™è€ƒ', gc.note
            )
        ) as grading_criteria
    FROM grading_criterion gc
    GROUP BY gc.syllabus_id
),
subject_data AS (
    SELECT 
        sub.subject_name_id,
        sub.curriculum_year,
        json_agg(
            json_build_object(
                'å­¦éƒ¨èª²ç¨‹', f.faculty_name,
                'ç§‘ç›®åŒºåˆ†', c.class_name,
                'ç§‘ç›®å°åŒºåˆ†', COALESCE(sc.subclass_name, ''),
                'å¿…é ˆåº¦', sub.requirement_type,
                'èª²ç¨‹åˆ¥ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£', sav.value
            )
        ) as subject_info
    FROM subject sub
    JOIN faculty f ON sub.faculty_id = f.faculty_id
    JOIN class c ON sub.class_id = c.class_id
    LEFT JOIN subclass sc ON sub.subclass_id = sc.subclass_id
    LEFT JOIN subject_attribute_value sav ON sub.subject_id = sav.subject_id
    LEFT JOIN subject_attribute sa ON sav.attribute_id = sa.attribute_id
        AND sa.attribute_name = 'èª²ç¨‹åˆ¥ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£'
    GROUP BY sub.subject_name_id, sub.curriculum_year
)
SELECT 
    json_build_object(
        'ç§‘ç›®å', sd.subject_name,
        'é–‹è¬›æƒ…å ±', json_agg(
            json_build_object(
                'å¹´', sd.syllabus_year,
                'ã‚·ãƒ©ãƒã‚¹', json_build_object(
                    'æ‹…å½“', COALESCE(id.instructors, '[]'::json),
                    'å­¦æœŸ', sd.term,
                    'æ›œæ—¥', COALESCE(ltd.lecture_times->0->>'æ›œæ—¥', ''),
                    'æ™‚é™', COALESCE(ltd.periods, '[]'::json),
                    'å˜ä½', sd.credits,
                    'æ•™ç§‘æ›¸', COALESCE(td.textbooks, '[]'::json),
                    'æ•™ç§‘æ›¸ã‚³ãƒ¡ãƒ³ãƒˆ', sd.textbook_comment,
                    'å‚è€ƒæ›¸', COALESCE(rd.references, '[]'::json),
                    'å‚è€ƒæ›¸ã‚³ãƒ¡ãƒ³ãƒˆ', sd.reference_comment,
                    'æˆç¸¾', COALESCE(gd.grading_criteria, '[]'::json),
                    'æˆç¸¾ã‚³ãƒ¡ãƒ³ãƒˆ', sd.grading_comment
                )
            )
        ),
        'å±¥ä¿®æƒ…å ±', json_agg(
            json_build_object(
                'å¹´', subd.curriculum_year,
                'å±¥ä¿®è¦ç¶±', subd.subject_info
            )
        )
    ) as cache_data
FROM syllabus_data sd
LEFT JOIN instructor_data id ON sd.syllabus_id = id.syllabus_id
LEFT JOIN lecture_time_data ltd ON sd.syllabus_id = ltd.syllabus_id
LEFT JOIN textbook_data td ON sd.syllabus_id = td.syllabus_id
LEFT JOIN reference_data rd ON sd.syllabus_id = rd.syllabus_id
LEFT JOIN grading_data gd ON sd.syllabus_id = gd.syllabus_id
LEFT JOIN subject_data subd ON sd.subject_name_id = subd.subject_name_id
GROUP BY sd.subject_name_id, sd.subject_name;
```

### ã‚¯ã‚¨ãƒªèª¬æ˜

#### ä¸»è¦CTEï¼ˆCommon Table Expressionï¼‰

1. **syllabus_data**: ã‚·ãƒ©ãƒã‚¹åŸºæœ¬æƒ…å ±ã®å–å¾—
2. **instructor_data**: æ‹…å½“æ•™å“¡æƒ…å ±ã®é›†ç´„
3. **lecture_time_data**: è¬›ç¾©æ™‚é–“æƒ…å ±ã®é›†ç´„
4. **textbook_data**: æ•™ç§‘æ›¸æƒ…å ±ã®é›†ç´„ï¼ˆbook + book_uncategorizedï¼‰
5. **reference_data**: å‚è€ƒæ›¸æƒ…å ±ã®é›†ç´„ï¼ˆbook + book_uncategorizedï¼‰
6. **grading_data**: æˆç¸¾è©•ä¾¡åŸºæº–ã®é›†ç´„
7. **subject_data**: å±¥ä¿®è¦ç¶±æƒ…å ±ã®é›†ç´„

#### ç‰¹å¾´

- **LEFT JOIN**: é–¢é€£ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚åŸºæœ¬æƒ…å ±ã‚’å–å¾—
- **COALESCE**: NULLå€¤ã®é©åˆ‡ãªå‡¦ç†
- **json_agg**: 1å¯¾å¤šã®é–¢ä¿‚ã‚’é…åˆ—ã¨ã—ã¦é›†ç´„
- **json_build_object**: æ§‹é€ åŒ–ã•ã‚ŒãŸJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿæˆ
- **GROUP BY**: ç§‘ç›®åå˜ä½ã§ã®ãƒ‡ãƒ¼ã‚¿é›†ç´„

[ğŸ” ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã¸](#jsonbã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆä»•æ§˜æ›¸) 
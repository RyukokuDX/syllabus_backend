---
title: JSONBキャッシュリスト仕様書
file_version: v3.0.1
project_version: v3.0.1
last_updated: 2025-07-09
---

# JSONBキャッシュリスト仕様書

- File Version: v3.0.1
- Project Version: v3.0.1
- Last Updated: 2025-07-09

[readmeへ](../../README.md) | [データベース構造定義へ](structure.md) | [設計ポリシーへ](policy.md) | [ER図へ](er.md)

## 目次

1. [概要](#概要)
2. [JSONB構造定義](#jsonb構造定義)
3. [フィールド命名規則](#フィールド命名規則)
4. [キャッシュ対象テーブル](#キャッシュ対象テーブル)
5. [キャッシュ生成方針](#キャッシュ生成方針)
6. [実装ガイドライン](#実装ガイドライン)

## 概要

### 目的
- 複雑なJOINクエリのパフォーマンス向上
- アプリケーション層でのデータアクセス効率化
- リアルタイム性を重視しない集計・分析処理の高速化

## JSONB構造定義

### スキーマ定義
```json
{
  "科目名": "string",
  "開講情報一覧": [
    {
      "年度": "number",
      "シラバス一覧": [
        {
          "担当教員一覧": [
            { "氏名": "string", "役割": "string" }
          ],
          "対象学部課程一覧": ["string"],
          "学期": "string",
          "講義時間一覧": [
            { "曜日": "string", "時限": "number" }
          ],
          "単位数": "number",
          "教科書一覧": [
            { "書名": "string", "著者": "string", "ISBN": "string", "価格": "number|null" }
          ],
          "参考書一覧": [ ... ],
          "成績評価基準一覧": [
            { "項目": "string", "割合": "number", "評価方法": "string", "備考": "string" }
          ]
        }
      ]
    }
  ],
  "履修情報一覧": [
    {
      "年度": "number",
      "履修要綱一覧": [
        {
          "学部課程": "string",
          "科目区分": "string",
          "科目小区分": "string",
          "必須度": "string",
          "学修プログラム一覧": ["number"],
          "専門応用履修要件": "string",
          // ↓ subject_attributeの値を属性名、subject_attribute_valueの値を属性値とする任意のフィールドが加わる場合あり
          // 例: "学修プログラム一覧": [1,2,3], "その他属性名": "属性値"
        }
      ]
    }
  ]
}
```

※履修要綱一覧の各要素には、subject_attributeの値を属性名、subject_attribute_valueの値を属性値とする任意のフィールドが加わる場合があります（例：「専門応用履修要件」など）。

### 型保証ルール
- 配列フィールドは必ず配列型で格納
- nullやスカラ値の混入を防止
- COALESCE(..., '[]'::json)で空配列を保証

## フィールド命名規則

### 基本方針
JSONBキャッシュのフィールド命名は、LLMがデータ構造を正確に理解できるよう、語尾による構造指標を一貫して使用する。

### 語尾による構造指標

| 構造 | 語尾 | 例 | 説明 |
|------|------|-----|------|
| 配列 | `一覧` | `教員一覧`, `教科書一覧` | 要素数0以上の繰り返し構造 |
| 単一値 | 名詞のまま、または`名`、`数`、`年度` | `科目名`, `単位数` | 固有の1つの値 |

### 命名規則の効果
- **クエリ精度向上**: `教員一覧[].氏名` のように正しいパスを推測
- **構造の明確化**: 配列か単一値かの曖昧さを排除
- **型推論の容易化**: JSON Schema生成にも役立つ
- **プロンプトのテンプレ化**: 「`〜一覧[].〜名` にアクセスせよ」など明示可能

## キャッシュ対象テーブル

### 主要テーブル
- **syllabus_master**: シラバスマスター情報
- **syllabus**: シラバス基本情報
- **subject_name**: 科目名マスター
- **syllabus_instructor**: シラバス担当教員
- **instructor**: 教員マスター
- **lecture_time**: 講義時間
- **syllabus_book**: シラバス書籍関連
- **book**: 書籍マスター
- **book_uncategorized**: 未分類書籍
- **syllabus_faculty**: シラバス学部課程関連
- **faculty**: 学部課程マスター
- **grading_criterion**: 成績評価基準
- **subject**: 履修要綱
- **class**: 科目区分マスター
- **subclass**: 科目小区分マスター
- **subject_attribute_value**: 科目属性値
- **subject_attribute**: 科目属性マスター

## キャッシュ生成方針

### 基本方針
1. **LLMによるアクセス性重視** idやコードを利用しない, 自然言語による解析
1. **階層構造の活用**: 親子関係を明確に表現
1. **配列の活用**: 1対多の関係を配列として表現（1件でも必ず配列）

## 実装ガイドライン

### 配列フィールドの型保証とエラー防止（LLM向け）
- **配列フィールドは必ず配列型で格納すること**
  - 例：`json_agg(...)`で生成し、`COALESCE(..., '[]'::json)`で空配列を保証する
- **nullやスカラ値が混入すると、jsonb_array_elements等で「スカラから要素を取り出すことはできません」エラーが発生する**
- **キャッシュ生成時、全ての配列フィールドにCOALESCEを適用し、空配列を保証すること**
- **型チェック用のデバッグクエリを活用し、配列でない値が混入していないか定期的に検証すること**
  - 例：
    ```sql
    SELECT COUNT(*) FROM syllabus_cache WHERE cache_name = 'subject_syllabus_cache' AND jsonb_typeof(cache_data->'開講情報一覧') IS DISTINCT FROM 'array';
    ```
- **LLMによる自動クエリ生成時も、配列型であることを前提に展開処理を記述すること**
# データベース更新フロー

[readmeへ](../../README.md) | [構造定義へ](structure.md) | [設計ポリシーへ](policy.md)

## 目次
1. [概要](#概要)
2. [更新フロー](#更新フロー)
3. [使用スクリプト](#使用スクリプト)
4. [エラー処理](#エラー処理)
5. [バックアップと復旧](#バックアップと復旧)
6. [監視とログ](#監視とログ)

## 概要
データベースの更新プロセスを定義し、安全かつ効率的なデータ更新を実現するためのフローを説明します。

## 更新フロー

### 1. データソースの取得
1. シラバス検索画面のクローリング
2. Webシラバスの解析
3. メディアセンターCSVの取得

### 2. データの前処理
1. データの形式チェック
2. 不正データの除外
3. 必要なデータ変換の実施

### 3. 更新処理
1. トランザクション開始
2. テーブルごとの更新
   - subject
   - syllabus
   - instructor
   - その他関連テーブル
3. 整合性チェック
4. コミットまたはロールバック

### 4. 後処理
1. ログの記録
2. バックアップの作成
3. 更新結果の通知

## 使用スクリプト

### データベース初期化
- スクリプト: `src/db/create_database.py`
- 用途: データベースの初期作成、テーブル構造の定義
- 実行タイミング: 初回構築時、またはデータベースの再構築時

### データ収集
- スクリプト: `src/db/raw_page_parser.py`
- 用途: シラバス検索ページとWebシラバスの解析
- 実行タイミング: 新学期開始時、データ更新時

### データ更新
- スクリプト: `src/db/update_db.py`
- 用途: 解析済みデータのデータベースへの反映
- 実行タイミング: データ収集後、または更新が必要な時

### データ検証
- スクリプト: `src/db/check_json.py`
- 用途: 更新用JSONファイルの形式チェック
- 実行タイミング: データ更新前の事前検証時

### 実行順序
1. `create_database.py`（初回のみ）
2. `raw_page_parser.py`
3. `check_json.py`
4. `update_db.py`

## エラー処理

### エラーの種類
1. データソース取得エラー
2. データ形式エラー
3. DB更新エラー
4. 整合性エラー

### エラー発生時の対応
1. エラーログの記録
2. 管理者への通知
3. 必要に応じたロールバック
4. リトライ処理の実行

## バックアップと復旧

### バックアップ方針
1. 更新前の完全バックアップ
2. 差分バックアップの定期実行
3. バックアップの保存期間管理

### 復旧手順
1. エラー状況の確認
2. 適切なバックアップの選択
3. 復旧作業の実行
4. 動作確認

## 監視とログ

### 監視項目
1. 更新処理の実行状況
2. エラーの発生状況
3. パフォーマンス指標
4. ディスク使用量

### ログ管理
1. 更新ログの記録
2. エラーログの保存
3. アクセスログの管理
4. ログローテーション

## 関連ドキュメント
- [データベース構造定義](structure.md)
- [データベース設計ポリシー](policy.md)
- [データベースER図](er.md)
- [データベースライブラリ仕様](python.md)
- [データベース操作クラス](../python/database.md)
- [データモデル定義](../python/models.md)

## 更新履歴

| 日付 | バージョン | 更新者 | 内容 |
|------|------------|--------|------|
| 2024-03-20 | 1.0.0 | 藤原 | 初版作成 |
| 2024-03-20 | 1.1.0 | 藤原 | 使用スクリプトセクションを追加 |

[🔝 ページトップへ](#データベース更新フロー)
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°æ‰‹é †æ›¸

[readmeã¸](../../README.md) | [doc.mdã¸](../doc.md)

## ç›®æ¬¡
0. [å³å¸­æ›´æ–°æ‰‹é †](#å³å¸­æ›´æ–°æ‰‹é †)
1. [æ¦‚è¦](#æ¦‚è¦)
2. [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
3. [æ›´æ–°ã®æµã‚Œ](#æ›´æ–°ã®æµã‚Œ)
4. [è©³ç´°æ‰‹é †](#è©³ç´°æ‰‹é †)
5. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

## å³å¸­æ›´æ–°æ‰‹é †
- `update/sample/`å†…ã®æ›´æ–°ã—ãŸã„ãƒ†ãƒ¼ãƒ–ãƒ«åã®ã‚µãƒ³ãƒ—ãƒ«jsonã‚’`update/{table}/add/`ã«ç§»å‹•
- è¨­ç½®ã—ãŸjsonã«è¿½åŠ ã—ãŸã„å†…å®¹ã‚’è¿½è¨˜
- developã«pushã—ã¦pull requestã‚’å‡ºã™
- ç®¡ç†è€…ãŒï¼¤ï¼¢ã‚’æ›´æ–°ï¼

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ã‚·ãƒ©ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°æ‰‹é †ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã¯ã€JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã€Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•ã™ã‚‹ã“ã¨ã§è¡Œã„ã¾ã™ã€‚
ä¸Šè¨˜ã‚ˆã‚Šã‚‚è¤‡é›‘ãªç‚ºã€ç§»è¡Œã®æ–‡ç« ã¯æ›´æ–°å¾Œã®DBã¾ã§ç¢ºèªã—ãŸã„äººå‘ã‘ã§ã™ã€‚

### ç›®çš„
- ã‚·ãƒ©ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªæ›´æ–°
- æ›´æ–°å±¥æ­´ã®ç®¡ç†
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®å¯¾å¿œ

### ç‰¹å¾´
- JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ç®¡ç†
- Dockerã«ã‚ˆã‚‹ç’°å¢ƒåˆ†é›¢
- æ‰‹å‹•ç¢ºèªã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ç¢ºä¿

## å‰ææ¡ä»¶

### å¿…è¦ãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢
- Docker Desktop
- Python 3.8ä»¥ä¸Š
- Visual Studio Codeï¼ˆæ¨å¥¨ï¼‰

### å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«
- `.env.sample`ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã¾ãŸã¯`.env`ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
- æ›´æ–°ç”¨ã®JSONãƒ•ã‚¡ã‚¤ãƒ«

## æ›´æ–°ã®æµã‚Œ

1. ç’°å¢ƒã®æº–å‚™
2. JSONãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®
3. Dockerã‚³ãƒ³ãƒ†ãƒŠã®å†èµ·å‹•
4. æ›´æ–°ã®ç¢ºèª

## è©³ç´°æ‰‹é †

### 1. ç’°å¢ƒã®æº–å‚™

#### 1-1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆåˆå›ã®ã¿ï¼‰
```bash
git clone https://github.com/yourusername/syllabus_backend.git
cd syllabus_backend
```

#### 1-2. ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
1. `.env.sample`ã‚’`docker/postgresql/.env`ã«ã‚³ãƒ”ãƒ¼
```bash
cd docker/postgresql
copy .env.sample .env
```

### 2. JSONãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®

#### 2-1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ç¢ºèª
æ›´æ–°ç”¨JSONãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¾ã™ï¼š
```
updates/
â””â”€â”€ subject/
    â”œâ”€â”€ add/      # æ–°è¦è¿½åŠ ãƒ‡ãƒ¼ã‚¿
    â”œâ”€â”€ update/   # æ›´æ–°ãƒ‡ãƒ¼ã‚¿
    â””â”€â”€ delete/   # å‰Šé™¤ãƒ‡ãƒ¼ã‚¿
```

#### 2-2. JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼
```json
{
  "content": {
    "subject_code": "AB1234",
    "subject_name": "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°åŸºç¤",
    "credit": 2,
    "created_at": "2024-03-20T10:00:00",
    "updated_at": "2024-03-20T10:00:00"
  }
}
```

#### 2-3. ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®
1. æ›´æ–°å†…å®¹ã«å¿œã˜ã¦é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é¸æŠ
   - æ–°è¦è¿½åŠ  â†’ `updates/subject/add/`
   - æ›´æ–° â†’ `updates/subject/update/`
   - å‰Šé™¤ â†’ `updates/subject/delete/`

2. JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
   - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ä»»æ„ï¼ˆä¾‹ï¼š`subject_001.json`ï¼‰
   - è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®ã‚‚å¯èƒ½

### 3. Dockerã‚³ãƒ³ãƒ†ãƒŠã®å†èµ·å‹•

#### 3-1. ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ãƒŠã®åœæ­¢
```bash
cd docker/postgresql
docker compose down
```

#### 3-2. ã‚³ãƒ³ãƒ†ãƒŠã®å†èµ·å‹•
```bash
docker compose up -d
```

### 4. æ›´æ–°ã®ç¢ºèª

#### 4-1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶š
```bash
# admin_userã¨ã—ã¦æ¥ç¶š
psql -h localhost -p 5432 -U admin_user -d syllabus_db
```

#### 4-2. ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
```sql
-- æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
SELECT * FROM subject WHERE updated_at > CURRENT_DATE - INTERVAL '1 day';

-- ç‰¹å®šã®ç§‘ç›®ã‚³ãƒ¼ãƒ‰ã®ç¢ºèª
SELECT * FROM subject WHERE subject_code = 'AB1234';
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã‚¨ãƒ©ãƒ¼
1. ãƒ­ã‚°ã®ç¢ºèª
```bash
docker logs postgresql-db
```

2. ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•
- ãƒãƒ¼ãƒˆç«¶åˆ
  ```bash
  # ä½¿ç”¨ä¸­ã®ãƒãƒ¼ãƒˆã®ç¢ºèª
  netstat -ano | findstr :5432
  ```
- æ¨©é™ã‚¨ãƒ©ãƒ¼
  - `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šã‚’ç¢ºèª
  - Dockerã®å†èµ·å‹•ã‚’è©¦ã™

### ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼
1. JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ç¢ºèª
   - å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ç¢ºèª
   - æ—¥ä»˜å½¢å¼ã®ç¢ºèª
   - æ–‡å­—ã‚³ãƒ¼ãƒ‰ã®ç¢ºèªï¼ˆUTF-8ï¼‰

2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ç¢ºèª
```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®ç¢ºèª
\d subject

-- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç¢ºèª
SELECT * FROM error_log ORDER BY created_at DESC LIMIT 10;
```

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒªã‚¹ãƒˆã‚¢
```bash
# æ›´æ–°å‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
docker exec postgresql-db pg_dump -U admin_user syllabus_db > backup_before_update.sql

# å•é¡Œç™ºç”Ÿæ™‚ã®ãƒªã‚¹ãƒˆã‚¢
cat backup_before_update.sql | docker exec -i postgresql-db psql -U admin_user -d syllabus_db
```

## è£œè¶³ï¼šãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
```bash
python src/db/migrations/generate_migration.py
```

2. ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
```bash
ls -l docker/postgresql/init/migrations/
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚

[ğŸ” ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã¸](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°æ‰‹é †æ›¸)
# データベース設計ポリシー

[readmeへ](../../README.md) | [構造定義へ](structure.md) | [ER図へ](er.md)

## 目次
1. [概要](#概要)
2. [基本方針](#基本方針)
3. [LLMフレンドリー設計](#LLMフレンドリー設計)
4. [正規化ポリシー](#正規化ポリシー)

## 1. テーブル命名規則

### 1.1 基本ルール
- テーブル名は英語の単数形を使用
- スネークケース（小文字のみ、アンダースコア区切り）を使用
- 略語は原則使用しない（例外：id, url など一般的なもの）
- 接頭や接尾辞に数字を使用しない
- 登録件数が変動するものは、中間テーブルに移行(可変長配列廃止)
  - 例外：書籍の著者情報は、検索の必要性が低く、正規化が困難なため、カンマ区切りの単一フィールドとして管理する

### 1.2 関連テーブルの命名
- 中間テーブルは関連する両方のテーブル名を結合（例：`syllabus_instructors`）
- 順序は主となるテーブル名を先に記述

## 2. カラム命名規則

### 2.1 基本ルール
- スネークケース（小文字のみ、アンダースコア区切り）を使用
- 略語は原則使用しない
- テーブル名と同じ接頭辞を持つカラム名は避ける（外部キーを除く）
- 意味が明確な名前を使用

### 2.2 共通カラム
- 主キー：
  - 元データから転用の場合：`[テーブル名]_code`（TEXT型、例：`syllabus_code`）
  - 自動生成の場合：
    - 外部キーとして使用される場合：`[テーブル名]_id`（INTEGER型）
    - 外部キーとして使用されない場合：`id`（INTEGER型）
- 外部キー： + `[テーブル名]_id`（例：`subject_name_id`）

#### タイムスタンプカラムの使用方針
1. マスターテーブル
   - `updated_at`は不要
   - 変更履歴はマイグレーションファイルで管理
   - マスターテーブルの例：
     - `class`
     - `subclass`
     - `class_note`
     - `faculty`
     - `subject_name`
     - `program`

2. トランザクションテーブル
   - `created_at`：必須（NOT NULL）
   - `updated_at`：必須（NULL許容）
   - データの変更履歴を追跡する必要がある
   - トランザクションテーブルの例：
     - `syllabus`
     - `syllabus_grade`
     - `subject`
     - `instructor`
     - `book`
     - `book_author`
     - `lecture_session`
     - `syllabus_faculty`
     - `syllabus_instructor`
     - `syllabus_book`
     - `grading_criterion`
     - `requirement`
     - `subject_program`

#### タイムスタンプの更新ルール
- 何れも, migrationファイルで指定
- 年度ごとのデータ管理が必要な場合は、年度フィールドを追加して更新頻度を抑制

#### 複合キーの使用方針
- NULLを許容するカラムは複合キーに使用しない
- 複合キーを使用する場合は、以下の条件を満たすこと
  - すべてのカラムがNOT NULL制約を持つ
  - カラムの組み合わせが一意性を保証する
  - インデックスのパフォーマンスを考慮した順序付け
- 複合キーを使用する代わりに、サロゲートキー（`id`）の使用を検討する
  - 例：syllabus_codeとsyllabus_year

## 3. データ型の選択基準

### 3.1 文字列
- 固定長：`CHAR`
- 可変長：`TEXT`
- URL：`TEXT`
- 備考・説明：`TEXT`

### 3.2 数値
- ID：`INTEGER`
- 年度：`INTEGER`
- 単位数：`INTEGER`
- 順序：`INTEGER`

### 3.3 日時
- タイムスタンプ：`TIMESTAMP`
- デフォルト値：`DEFAULT CURRENT_TIMESTAMP`

## 4. インデックス設計

### 4.1 必須インデックス
- 主キー
- 外部キー
- 検索頻度の高いカラム
- 結合条件として使用されるカラム

### 4.2 インデックス命名規則
- 接頭辞：`idx_`
- テーブル名とカラム名を含める
- 複合インデックスの場合はカラム名を順序通りに記述

## 5. 制約

### 5.1 必須制約
- 主キー制約
- 外部キー制約（`ON DELETE CASCADE` または `ON DELETE SET NULL`）
- NOT NULL制約（必須項目）

### 5.2 整合性制約
- 一意性制約（必要な場合）
- チェック制約（値の範囲や形式）

## 6. セキュリティ

### 6.1 データ保護
- 機密情報は暗号化して保存
- パスワードはハッシュ化
- 個人情報は必要最小限に留める

### 6.2 アクセス制御
- 適切な権限設定
- 監査ログの記録
- 定期的なバックアップ

## 7. パフォーマンス考慮事項

### 7.1 テーブル設計
- 適切な正規化レベルの選択
- 必要に応じた非正規化の検討
- 大規模データの分割管理

### 7.2 クエリ最適化
- 効率的なインデックス設計
- 適切なデータ型の選択
- 不要なインデックスの削除

## 8. 変更管理

### 8.1 スキーマ変更
- 変更履歴の記録
- マイグレーションスクリプトの作成
- 下位互換性の考慮

### 8.2 ドキュメント管理
- スキーマ定義の最新化
- 変更理由の記録
- API仕様書との整合性確保 

## 関連ドキュメント
- [データベース構造定義](structure.md)
- [データベースER図](er.md)
- [データベースライブラリ仕様](python.md)

## 更新履歴

| 日付 | バージョン | 更新者 | 内容 |
|------|------------|--------|------|
| 2025-05-20 | 1.0.1 | 藤原 | 初版作成 |
| 2025-05-21 | 1.1.0 | 藤原 | 主キー命名規則の修正（外部キーとして使用される場合の命名を`id`に統一） |

## LLMフレンドリー設計

### 基本方針
データベース設計において、LLM（大規模言語モデル）がデータを理解・生成しやすい構造を採用する。

### 具体的な設計指針

1. ビットマスクの回避
   - 複数の状態や属性を表現する際、ビットマスクではなく中間テーブルを使用
   - 例：履修可能学年の表現
     - 非推奨：`grade_mask`（ビットマスク）
     - 推奨：`syllabus_grade`（中間テーブル）

2. 直感的な命名規則
   - 略語や特殊な記号を避け、意味が明確な名前を使用
   - 例：
     - 非推奨：`usr_id`, `grp_cd`
     - 推奨：`user_id`, `group_code`

3. テキストデータの活用
   - コード値や数値による表現を避け、可能な限りテキストで表現
   - 例：
     - 非推奨：`status = 1`（1: 有効, 2: 無効）
     - 推奨：`status = 'active'`

4. 正規化の徹底
   - データの重複を避け、明確な関連性を持つテーブルに分割
   - 中間テーブルを活用した多対多の関係の表現

5. コメントの充実
   - 各テーブル、カラムの目的と意味を明確に記述
   - 制約やビジネスルールの説明を追加

### 期待される効果

1. データの解釈性向上
   - LLMがデータの意味を正確に理解可能
   - 自然言語での問い合わせへの適切な応答

2. データ生成の精度向上
   - 構造化されたデータの生成が容易
   - 一貫性のあるデータの作成

3. メンテナンス性の向上
   - 人間が理解しやすい構造
   - 変更や拡張が容易

4. エラーリスクの低減
   - データの誤解釈による問題の防止
   - 一貫性チェックの容易化

[目次へ戻る](#目次)

[🔝 ページトップへ](#データベース設計ポリシー)

## 正規化ポリシー

### 基本方針
データベースの正規化は、データの整合性と効率性を確保するために行う。ただし、過度な正規化は避け、実用的な正規化レベルを維持する。

### 正規化レベル

1. **第1正規形（1NF）**
   - すべてのテーブルは1NFを満たす必要があります。
   - 各カラムは原子値（分割不可能な値）である必要があります。

2. **第2正規形（2NF）**
   - すべてのテーブルは2NFを満たす必要があります。
   - 部分従属性を排除し、完全従属性を確保します。

3. **第3正規形（3NF）**
   - すべてのテーブルは3NFを満たす必要があります。
   - 推移的従属性を排除し、直接従属性を確保します。

4. **第4正規形（4NF）**
   - 4NFは1対多の関係のみに適用します。
   - 多値従属性は、中間テーブルを使用して適切に分離します。
   - 結合従属性による非正規化は避けます。

### 正規化の実装方針

1. **中間テーブルの活用**
   - 多対多の関係は、中間テーブルを使用して表現します。
   - 例：`syllabus_grade`, `syllabus_faculty`, `syllabus_instructor`など

2. **非正規データの分離管理**
   - 本来のデータ構造が侵されているレコードが多数ある場合は、非正規データ用のテーブルを設ける
   - 例：書籍管理において、ISBNで正規に管理できないレコードが多数ある場合
     - 正規テーブル：`book`（ISBNによる管理）
     - 非正規テーブル：`book_uncategorized`（ISBNなし、不正ISBN等）
   - 理由：
     - 正規のデータは正規に扱いたい
     - 将来的の非正規なデータのUIによる撲滅祈念
     - データの整合性と保守性の向上

3. **LLMフレンドリー**
   - テーブル間の関係は明確に定義し、LLMが理解しやすい構造を維持します。
   - 中間テーブルを使用して、多対多の関係を明確に表現します。

4. **パフォーマンス**
   - 正規化は、データの整合性と効率性を確保するために行います。
   - 過度な正規化は避け、実用的な正規化レベルを維持します。

### 非正規化の検討

1. **パフォーマンス向上**
   - 検索頻度の高いデータは、必要に応じて非正規化を検討します。
   - ただし、データの整合性を損なわない範囲で行います。

2. **LLMフレンドリー**
   - 非正規化は、LLMの理解を難しくする可能性があるため、慎重に検討します。
   - 必要最小限の非正規化に留めます。

[目次へ戻る](#目次)
# データベース設計ポリシー

[readmeへ](../../README.md) | [構造定義へ](structure.md) | [ER図へ](er.md)

## 目次
1. [概要](#概要)
2. [基本方針](#基本方針)
3. [セキュリティ対策](#セキュリティ対策)
4. [バックアップ方針](#バックアップ方針)
5. [監視方針](#監視方針)
6. [メンテナンス方針](#メンテナンス方針)
7. [インシデント対応](#インシデント対応)

## 1. テーブル命名規則

### 1.1 基本ルール
- テーブル名は英語の単数形を使用
- スネークケース（小文字のみ、アンダースコア区切り）を使用
- 略語は原則使用しない（例外：id, url など一般的なもの）
- 接頭や接尾辞に数字を使用しない
- 登録件数が変動するものは、中間テーブルに移行(可変長配列廃止)

### 1.2 関連テーブルの命名
- 中間テーブルは関連する両方のテーブル名を結合（例：`syllabus_instructors`）
- 順序は主となるテーブル名を先に記述

## 2. カラム命名規則

### 2.1 基本ルール
- スネークケース（小文字のみ、アンダースコア区切り）を使用
- 略語は原則使用しない
- テーブル名と同じ接頭辞を持つカラム名は避ける
- 意味が明確な名前を使用

### 2.2 共通カラム
- 主キー：`id`（数値型）または意味のある名前（例：`subject_code`）
- 外部キー：参照先テーブル名の単数形 + `_id`
- 作成日時：`created_at`
- 更新日時：`updated_at`（必要な場合のみ）

#### updated_atの使用方針
- 以下の条件に該当するテーブルには`updated_at`を設ける
  - データの更新が頻繁に発生する可能性がある
  - データの更新履歴を追跡する必要がある
  - データの整合性確認が必要
- `updated_at`はNULLを許容する（`TIMESTAMP NULL`）
- 更新時はマイグレーションファイルで明示的に時刻を設定
- 年度ごとのデータ管理が必要な場合は、年度フィールドを追加して更新頻度を抑制

#### 複合キーの使用方針
- NULLを許容するカラムは複合キーに使用しない
- 複合キーを使用する場合は、以下の条件を満たすこと
  - すべてのカラムがNOT NULL制約を持つ
  - カラムの組み合わせが一意性を保証する
  - インデックスのパフォーマンスを考慮した順序付け
- 複合キーを使用する代わりに、サロゲートキー（`id`）の使用を検討する

## 3. データ型の選択基準

### 3.1 文字列
- 固定長：`CHAR`
- 可変長：`TEXT`
- URL：`TEXT`
- 備考・説明：`TEXT`

### 3.2 数値
- ID：`INTEGER`
- 年度：`INTEGER`
- 単位数：`INTEGER`
- 順序：`INTEGER`

### 3.3 日時
- タイムスタンプ：`TIMESTAMP`
- デフォルト値：`DEFAULT CURRENT_TIMESTAMP`

## 4. インデックス設計

### 4.1 必須インデックス
- 主キー
- 外部キー
- 検索頻度の高いカラム
- 結合条件として使用されるカラム

### 4.2 インデックス命名規則
- 接頭辞：`idx_`
- テーブル名とカラム名を含める
- 複合インデックスの場合はカラム名を順序通りに記述

## 5. 制約

### 5.1 必須制約
- 主キー制約
- 外部キー制約（`ON DELETE CASCADE` または `ON DELETE SET NULL`）
- NOT NULL制約（必須項目）

### 5.2 整合性制約
- 一意性制約（必要な場合）
- チェック制約（値の範囲や形式）

## 6. セキュリティ

### 6.1 データ保護
- 機密情報は暗号化して保存
- パスワードはハッシュ化
- 個人情報は必要最小限に留める

### 6.2 アクセス制御
- 適切な権限設定
- 監査ログの記録
- 定期的なバックアップ

## 7. パフォーマンス考慮事項

### 7.1 テーブル設計
- 適切な正規化レベルの選択
- 必要に応じた非正規化の検討
- 大規模データの分割管理

### 7.2 クエリ最適化
- 効率的なインデックス設計
- 適切なデータ型の選択
- 不要なインデックスの削除

## 8. 変更管理

### 8.1 スキーマ変更
- 変更履歴の記録
- マイグレーションスクリプトの作成
- 下位互換性の考慮

### 8.2 ドキュメント管理
- スキーマ定義の最新化
- 変更理由の記録
- API仕様書との整合性確保 

## 関連ドキュメント
- [データベース構造定義](structure.md)
- [データベースER図](er.md)
- [データベースライブラリ仕様](python.md)

## 更新履歴

| 日付 | バージョン | 更新者 | 内容 |
|------|------------|--------|------|
| 2024-03-20 | 1.0.0 | 藤原 | 初版作成 |

[🔝 ページトップへ](#データベース設計ポリシー)